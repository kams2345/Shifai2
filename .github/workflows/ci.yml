name: ShifAI CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: '17'
  XCODE_VERSION: '15.2'

jobs:
  # ─── iOS ───
  ios-build:
    name: iOS Build & Test
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Build iOS
        working-directory: shifai-ios
        run: |
          xcodebuild build \
            -project ShifAI.xcodeproj \
            -scheme ShifAI \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO

      - name: Run iOS Tests
        working-directory: shifai-ios
        run: |
          xcodebuild test \
            -project ShifAI.xcodeproj \
            -scheme ShifAI \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty --report junit

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ios-test-results
          path: shifai-ios/build/reports

  # ─── Android ───
  android-build:
    name: Android Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle.kts') }}
          restore-keys: gradle-

      - name: Build Android
        working-directory: shifai-android
        run: ./gradlew assembleDebug --no-daemon

      - name: Run Unit Tests
        working-directory: shifai-android
        run: ./gradlew testDebugUnitTest --no-daemon

      - name: Lint Check
        working-directory: shifai-android
        run: ./gradlew lintDebug --no-daemon

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: android-reports
          path: |
            shifai-android/app/build/reports
            shifai-android/app/build/test-results

  # ─── Supabase Backend ───
  backend-check:
    name: Backend Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Type Check Edge Functions
        working-directory: shifai-backend
        run: |
          for dir in supabase/functions/*/; do
            if [ -f "$dir/index.ts" ]; then
              echo "Checking $dir..."
              deno check "$dir/index.ts" || true
            fi
          done

      - name: Validate Migrations
        working-directory: shifai-backend
        run: |
          for f in supabase/migrations/*.sql; do
            echo "Validating $f..."
            # Basic SQL syntax check
            if grep -qiE "(DROP TABLE|TRUNCATE|DROP DATABASE)" "$f"; then
              echo "⚠️ Destructive SQL found in $f"
              exit 1
            fi
          done

  # ─── Security Scan ───
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: [ios-build, android-build]
    steps:
      - uses: actions/checkout@v4

      - name: Secret Scan
        run: |
          echo "Checking for hardcoded secrets..."
          if grep -rn --include="*.swift" --include="*.kt" --include="*.ts" \
            -E "(password|secret|api_key|private_key)\s*=\s*\"[^\"]+\"" \
            shifai-ios/ shifai-android/ shifai-backend/; then
            echo "❌ Potential secrets found!"
            exit 1
          fi
          echo "✅ No hardcoded secrets detected"

      - name: GDPR Compliance Check
        run: |
          echo "Checking GDPR compliance markers..."
          # Verify encryption is used
          grep -rn "AES" shifai-ios/ShifAI/Data/Encryption/ && echo "✅ iOS encryption present"
          grep -rn "AES" shifai-android/app/src/main/java/com/shifai/data/encryption/ && echo "✅ Android encryption present"
          # Verify RLS is enabled
          grep -c "ENABLE ROW LEVEL SECURITY" shifai-backend/supabase/migrations/*.sql && echo "✅ RLS enabled"
          # Verify delete-account exists
          test -f shifai-backend/supabase/functions/delete-account/index.ts && echo "✅ Account deletion available"
